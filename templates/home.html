
{% extends 'base.html' %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="/static/css/style.css">
{% endblock %}
{% block content %}

    <h1>painting</h1>
    <div class="paintings infinite-container">
        {%for paint in object_list %}
            <div class="paint infinite-item" data-id="{{paint.id}}">
                
                <h3>{{paint.title}}</h3>
                <img src="/uploads/{{paint.image}}" style="width: 300px;">
                <p>writer : {{paint.owner}}</p>
                <p>ì‘ì„±ì‹œê°„: {{paint.created_string}}</p>
                <span>liked : {{paint.likes.count}}</span>
                <button class="like-btn" onclick="like_func">ì¢‹ì•„ìš”</button>
                {% if paint.owner == request.user %}
                    <button class="del-btn">ì‚­ì œ ğŸ—‘</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    {% if page_obj.has_next %}
        <a class="infinite-more-link" href ="?page={{ page_obj.next_page_number }}"></a>
    {% endif %}
<div id="hidden-box" >ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
{% endblock %}
{% block script %}
<script src="{% static "js/jquery.waypoints.min.js" %}"></script>
<script src="/static/js/infinite.min.js"></script>

<script>
    const infinite = new Waypoint.Infinite({
        element: $('.infinite-container')[0],
        offset: 'bottom-in-view',
        onBeforePageLoad : function(){
            $('#hidden-box').show()
        },
        onAfterPageLoad: function(){
            $('#hidden-box').hide()

        }

    })
    const like_fun = (e) => {
        e.preventDefault()
        const arr = e.target.parentNode.children[4].innerText.split(' ')
        const number = parseInt(arr[arr.length - 1])
        const paint_id = e.target.parentNode.dataset.id
        $.ajax({
            type:"POST",
            url:`http://localhost:8000/api/paints/like/${paint_id}`,
            success : function(json) {
                if (json.msg == 'delete'){
                    e.target.parentNode.children[4].innerText = `liked : ${number - 1}`
                } else if (json.msg == 'ok') {
                    e.target.parentNode.children[4].innerText = `liked : ${number + 1}`
                } else {
                    alert(json.msg)
                }
            }
            });

    }

    
    const delBtns = document.querySelectorAll('.del-btn')
    for (i=0;i<delBtns.length;i++){
        delBtns[i].addEventListener('click',(e)=>{
            e.preventDefault()
            const paint_id = e.target.parentNode.dataset.id
            $.ajax({
                type:"DELETE",
                url:`http://localhost:8000/api/paints/delete/${paint_id}`,
                success : function(json) {
                    if (json.msg == 'delete') {
                        alert('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')
                        window.location.reload()
                    } else if (json.msg == 'err-user') {
                        alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.')
                    } else if (json.msg == 'not founded') {
                        alert('ê²Œì‹œë¬¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                    }
                }
                });
        })
    }


    $.ajaxSetup({
        headers: { "X-CSRFToken": '{{csrf_token}}' }
      });
</script>
{% endblock %}
<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Document</title>
</head>
<body>
    <h1>painting</h1>
    <div class="paintings">
        {%for paint in paintings %}
            <div class="paint" data-id="{{paint.id}}">
                {% if paint.owner == request.user %}
                    <button class="del-btn">ì‚­ì œ ğŸ—‘</button>
                {% endif %}
                <h3>{{paint.title}}</h3>
                <img src="/uploads/{{paint.image}}" style="width: 300px;">
                <p>writer : {{paint.owner}}</p>
                <p>ì‘ì„±ì‹œê°„: {{paint.created_string}}</p>
                <span>liked : {{paint.likes.count}}</span>
                <button class="like-btn">ì¢‹ì•„ìš”</button>
            </div>
        {% endfor %}
    </div>
    <script>
            const likeBtn = document.querySelector('.like-btn')
            const like = document.querySelector('.like-btn')
            const preview = document.getElementById('preview')
            const submitBtn = document.getElementById('submitBtn')
            likeBtn.addEventListener('click',(e)=>{
                e.preventDefault()
                const arr = e.target.parentNode.children[4].innerText.split(' ')
                const number = parseInt(arr[arr.length - 1])
                const paint_id = e.target.parentNode.dataset.id
                $.ajax({
                    type:"POST",
                    url:`http://localhost:8000/api/paints/like/${paint_id}`,
                    success : function(json) {
                        if (json.msg == 'delete'){
                            e.target.parentNode.children[4].innerText = `liked : ${number - 1}`
                        } else if (json.msg == 'ok') {
                            e.target.parentNode.children[4].innerText = `liked : ${number + 1}`
                        } else {
                            alert(json.msg)
                        }
                    }
                    });
            })
            
            const delBtn = document.querySelector('.del-btn')
            delBtn.addEventListener('click',(e)=>{
                e.preventDefault()
                const paint_id = e.target.parentNode.dataset.id
                $.ajax({
                    type:"DELETE",
                    url:`http://localhost:8000/api/paints/delete/${paint_id}`,
                    success : function(json) {
                        if (json.msg == 'delete') {
                            alert('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')
                            window.location.reload()
                        } else if (json.msg == 'err-user') {
                            alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.')
                        } else if (json.msg == 'not founded') {
                            alert('ê²Œì‹œë¬¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                        }
                    }
                    });
            })

            $.ajaxSetup({
                headers: { "X-CSRFToken": '{{csrf_token}}' }
              });
    </script>
</body>
</html> -->